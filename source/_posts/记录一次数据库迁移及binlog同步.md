---
title: 记录一次数据库迁移及binlog同步
date: 2023-12-21 17:36:23
tags: 数据库
---

近期手上相关项目由于一些不可抗力原因，需要做数据库迁移，记录遇到的一些问题及binlog同步。
<!-- more --> 

## 数据库
数据库迁移首先考虑新旧数据库同步问题，我们当前旧数据库采用MHA架构一主一从方案；在新数据库中采用同样的配置，通过binlog进行新旧数据的同步。

### binlog
binlog是数据库中的一种日志，记录了执行语句的逻辑操作（如DML和DDL），主要用于数据恢复和数据同步。


#### binlog配置
binlog有三种格式：statement、row和mixed。
* statement：仅记录操作语句，不记录最终的值；当用到触发器，函数时，不能保证再次运行时的一致性
* row：记录每行的数据改动而非操作语句；当一条操作语句修改多条记录时，日志数据量较大
* mixed：DML并且主从可能会不一致时，通过row格式记录；否则通过statement格式记录

#### 日志写入
binlog在记录事务过程中，会先把日志写入binlog cache，当事务提交时，才会将binlog cache记录到binlog文件中，保证事务的一致性。

同时binlog记录日志时，会先将日志记录在内存中，再根据配置规则，写入硬盘；配置的规则可以通过```sync_binlog```修改。将其值设置为整数**N**，表示每**N**个事务写入一次硬盘；设置为**0**时，将有文件系统自己判定写入时机（需注意**N**不要设置为太大，避免宕机时的数据丢失；也不要设置太小，避免影响性能）。


#### 日志同步
当有了binlog日志，即可通过日志在新库中恢复数据。市面上有了一些成熟的开源库，利用binlog同步到不止mysql以外的其他库中，如oracl、redis、ElasticSearch等。

目前新库没有项目写入数据，所以可以暂不考虑**索引**、**同时更新**、**循环更新**等复杂问题。

##### max_allowed_packet
```max_allowed_packet```限制了数据库导入一个数据包的大小；而有些数据操作在binlog中记录的单条sql大小会比较大，新库的默认```max_allowed_packet```值会导致同步失败，需要调整```max_allowed_packet```为合适大小。

## 项目
项目在迁移数据库前，需要停止对数据库的写入、或数据库设置只读 或 进行数据库双写的改造，避免迁移时造成的数据不一致问题。

由于我们只迁移旧数据库集群中部分数据库，对数据库集群进行只读操作会影响其他业务，对此我们采用的在业务低峰时，对应用进行停服切换。

对各个项目停服后通过验证每个表的count，验证数据的一致性后，再进行切换配置并重启各个项目。