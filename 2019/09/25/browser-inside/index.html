<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>浏览器工作过程 | Lawrence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Lawrence</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://lawrencebla.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-browser-inside" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/25/browser-inside/" class="article-date">
  <time datetime="2019-09-25T10:53:06.000Z" itemprop="datePublished">2019-09-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      浏览器工作过程
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="浏览器架构"><a href="#浏览器架构" class="headerlink" title="浏览器架构"></a>浏览器架构</h1><p>浏览器内部有许多进程负责浏览器中不同的模块功能，如浏览器进程负责浏览器的宿主部分，渲染进程负责文档的渲染部分。进程之间通过IPC进行通信。<br><img src="/2019/09/25/browser-inside/01.png"></p>
<p>进程中还可能存在许多线程。<br><img src="/2019/09/25/browser-inside/02.png"><br><em>浏览器进程包含UI线程，网络线程等。</em></p>
<p>具体的进程和线程在不同浏览器中，实现方式各不相同。这里以chrome为例。</p>
<p>chrome会为每个tab都创建一个渲染进程，保证页面生命周期与内容的隔离，还避免了被其他tab阻塞渲染的问题；浏览器进程负责与其他进程之间进行协调。<br><img src="/2019/09/25/browser-inside/03.png"></p>
<p>chrome中主要有如下几个进程：</p>
<ul>
<li>浏览器进程：负责宿主环境的UI功能（UI线程，如地址栏，书签，后退等）、网络功能（网络线程）、IO功能（存储线程）以及授权功能*。</li>
<li>渲染进程：负责渲染页面的内容。</li>
<li>GPU进程：将渲染的内容光栅化显示到屏幕中。</li>
<li>插件进程：负责页面插件功能。<img src="/2019/09/25/browser-inside/04.png">
<a id="more"></a> 
</li>
</ul>
<h1 id="浏览器渲染流程"><a href="#浏览器渲染流程" class="headerlink" title="浏览器渲染流程"></a>浏览器渲染流程</h1><h2 id="初始化-重定向"><a href="#初始化-重定向" class="headerlink" title="初始化/重定向"></a>初始化/重定向</h2><p>当用户在地址栏中进行输入，当用户按下回车时，UI线程判断如果输入的内容时一个URL，通知网络线程进行请求。</p>
<p>网络线程会进行安全校验：检查请求的URL是否安全或者跨域，不安全提示用户并终止后续行为；<br>网络线程也会处理一些响应的结果，如返回的http头301，则进行重定向，发起另外一个网络请求；<br>当检测到Content-Type为html时，会将数据传递到渲染进程。</p>
<img src="/2019/09/25/browser-inside/05.png">
<p><em>检测完毕后，UI线程还会更新浏览器的“历史记录”，“网站状态”等信息</em></p>
<p>当tab关闭或者重定向时，浏览器进程会询问渲染进程，是否有绑定beforeunload方法并调用<br><img src="/2019/09/25/browser-inside/06.png"></p>
<h2 id="渲染"><a href="#渲染" class="headerlink" title="渲染"></a>渲染</h2><p>渲染进程用于将页面内容展示到屏幕中。<br><img src="/2019/09/25/browser-inside/07.png"><br><em>渲染进程主要由主线程、组合线程、光栅线程等组成</em></p>
<h3 id="解析生成dom树"><a href="#解析生成dom树" class="headerlink" title="解析生成dom树"></a>解析生成dom树</h3><p>渲染进程接收到HTML时，交给主线程将HTML文本解析为DOM树。<br><img src="/2019/09/25/browser-inside/parsing-model-overview.png"></p>
<p>由于JS代码可能会修改DOM树，所以JS会阻塞主DOM的生成，当JS执行结束后，才会继续解析生成DOM；如果你确保JS代码中，没有修改DOM的内容，可以使用async或defer使JS异步执行，不阻塞DOM的生成。</p>
<ul>
<li>preload：为了让首屏网络可以留给最需要展示的内容，有些不那么重要的资源可以标记为preload；</li>
<li>prefetch 对于第二屏需要展示的内容，可以使用prefetch进行标记，在网络请求充足的情况下，会获取prefetch的资源。<br><em>preload的优先级高于prefetch</em></li>
</ul>
<h3 id="加载资源"><a href="#加载资源" class="headerlink" title="加载资源"></a>加载资源</h3><p>正常情况下，解析HTML时遇到了img或link标签时，才会去加载资源；但是为了优化性能，渲染进程会预扫描一遍HTML文本，当检测到由img或link标签时，会启动浏览器进程中的网络线程进行请求预加载数据。<br><img src="/2019/09/25/browser-inside/08.png"></p>
<h3 id="生成css树"><a href="#生成css树" class="headerlink" title="生成css树"></a>生成css树</h3><p>只有DOM树的情况下，浏览器并不知道每个DOM应该是什么样子，这个时候就需要CSS树；主线程解析CSS文件，并根据选择器绘制出一颗CSS树。<br><img src="/2019/09/25/browser-inside/09.png"></p>
<h3 id="生成布局树"><a href="#生成布局树" class="headerlink" title="生成布局树"></a>生成布局树</h3><p>只有DOM树和CSS树的情况下，浏览器只知道有CSS描述的内容该如何展示，如颜色、字体或定义过的宽、高等；而其他的元素浏览器不知道该显示在哪里，显示多大，所以布局树就是根据文档流，计算出每个元素排列后应该在的位置，宽高等。<br>布局树的元素与DOM树类似，但是又有些不同；比如：伪元素会在布局树中存在；display: none却不在布局树中存在。<br><img src="/2019/09/25/browser-inside/10.png"></p>
<h3 id="绘制步骤"><a href="#绘制步骤" class="headerlink" title="绘制步骤"></a>绘制步骤</h3><p>渲染进程会根据上面完成的DOM树、CSS树及布局树，创建绘制步骤。<br>如先画一个长方形，位置多少，宽高是多少，什么颜色；下一步再绘制一个文本。<br><img src="/2019/09/25/browser-inside/11.png"></p>
<h3 id="光栅化"><a href="#光栅化" class="headerlink" title="光栅化"></a>光栅化</h3><p>有了绘制步骤后，浏览器可以根据窗口大小及位置，将内容绘转换为像素；这个步骤被叫做光栅化；当滚动时，窗口位置调整，绘制更多的信息。<br><img src="/2019/09/25/browser-inside/12.png"></p>
<h3 id="图层树"><a href="#图层树" class="headerlink" title="图层树"></a>图层树</h3><p>对整个页面光栅化会导致一个问题：如果对页面页面元素或样式进行修改，会重新对整个页面重新生成布局树及绘制步骤等；而现代很多页面都会出现大量修改的功能。<br>为了优化这一过程现代浏览器引入了图层树的概念；即将页面分为不同图层，并对每个图层做单独光栅化；单个图层中的内容被改动后，只有单个图层被重新生成布局树和绘制。<br><img src="/2019/09/25/browser-inside/13.png"></p>
<p>但是如果对每个元素都做成一个图层，浏览器消耗的资源也非常大，所以浏览进程的主线程会计算哪个元素属于哪个图层<br><img src="/2019/09/25/browser-inside/14.png"></p>
<ul>
<li>will-change：一些如侧边收缩栏这种更新频繁，又不影响文档流；可以使用will-change属性，告诉浏览器，把这个元素做成一个单独的图层；被标记的元素属性修改后，只会重新处理自己这个图层。</li>
</ul>
<p>上面的光栅化好的图层，会由合成线程根据窗口位置大小，判断哪些内容需要展示，并将光栅化之后的内容合成在一起，当窗口改变时，会渲染新的帧用于填充。</p>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>用户对页面进行操作时，浏览器进程会监听到时什么事件在哪个位置。<br>再把位置发给渲染进程，渲染进程通过绘制过程中的数据，确定事件响应在哪个元素中，用来处理事件回调。</p>
<p>当对应元素处于可视窗口中时，浏览器会将事件发送给主线程，等待主线程理事件回调完毕， 然后在重新进行合成，这就会造成浏览器的展示不流畅；我们可以添加addEventListener的第三个参数：{ passive, true }用于告诉浏览器，合成新帧时不需要等待（如果需要禁用浏览器的默认事件，不能加入该参数）。</p>
<h2 id="帧数"><a href="#帧数" class="headerlink" title="帧数"></a>帧数</h2><p>为了使页面看起来更平顺，大多数显示器至少保持着60帧的速度在刷新（即每秒60次），当低于60帧时，会感觉到页面卡顿现象。</p>
<h3 id="JS阻塞"><a href="#JS阻塞" class="headerlink" title="JS阻塞"></a>JS阻塞</h3><p>由于页面中树的生成、绘制步骤，都在渲染进程的主线程中执行，js代码也是在主线程中执行，所以当有花费时间较高js在执行时，进行页面绘制会被阻塞。<br><img src="/2019/09/25/browser-inside/15.png"></p>
<p>使用requestAnimationFrame可以拆分长时间js，在每个页面更新周期执行一部分代码，避免页面更新延迟。<br><img src="/2019/09/25/browser-inside/16.png"></p>
<p>也可以将这部分代码放入Web Worker中，由于Web Worker有专门的worker线程进行处理，所以不会造成主线程的更新延迟。</p>
<h3 id="事件延迟"><a href="#事件延迟" class="headerlink" title="事件延迟"></a>事件延迟</h3><p>当用户事件的频率超过浏览器更新帧数时，会出现事件延迟问题。<br>如FPS为60，鼠标滑动时，每秒滑动120次，第一帧渲染第一个事件，第二帧渲染第二个事件，1秒后只能渲染前60次的渲染结果，即只完成了一半。<br><img src="/2019/09/25/browser-inside/17.png"></p>
<p>对此浏览器合并了高频事件，将执行延迟到下一个requestAnimationFrame之前<br><img src="/2019/09/25/browser-inside/18.png"></p>
<p>但是如果用户像用到真实所有的事件（如画一条弧线时），合并帧对导致中间线条不圆滑；<br>浏览器在evnet事件中，提供了getCoalescedEvents方法，可以取出所有真实的事件，以供用户使用。<br><img src="/2019/09/25/browser-inside/19.png"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part1" target="_blank" rel="noopener">Inside look at modern web browser (part 1)</a></li>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part2" target="_blank" rel="noopener">Inside look at modern web browser (part 2)</a></li>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part3" target="_blank" rel="noopener">Inside look at modern web browser (part 3)</a></li>
<li><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part4" target="_blank" rel="noopener">Inside look at modern web browser (part 4)</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/resource-prioritization" target="_blank" rel="noopener">Resource Prioritization</a></li>
<li><a href="https://developers.google.com/web/fundamentals/performance/rendering/optimize-javascript-execution" target="_blank" rel="noopener">Optimizing JavaScript Execution</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://lawrencebla.github.io/2019/09/25/browser-inside/" data-id="ck7rs1u4b001c28hqd0xucc5f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/浏览器/">浏览器</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/11/01/KV Storage/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          KV Storage
        
      </div>
    </a>
  
  
    <a href="/2019/09/16/使用github actions发布hexo/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">使用github actions发布hexo</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Blog/">React Blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github-actions/">github actions</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/new-feature/">new feature</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/优化/">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/概览/">概览</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/浏览器/">浏览器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线性回归/">线性回归</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/React-Blog/" style="font-size: 20px;">React Blog</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/github-actions/" style="font-size: 10px;">github actions</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/new-feature/" style="font-size: 10px;">new feature</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/优化/" style="font-size: 10px;">优化</a> <a href="/tags/概览/" style="font-size: 20px;">概览</a> <a href="/tags/浏览器/" style="font-size: 15px;">浏览器</a> <a href="/tags/线性回归/" style="font-size: 10px;">线性回归</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/04/location_search_and_hash/">location的search(?)与hash(#)顺序</a>
          </li>
        
          <li>
            <a href="/2019/11/22/building-great-user-experiences-with-concurrent-mode-and-suspense/">(概述)building-great-user-experiences-with-concurrent-mode-and-suspense</a>
          </li>
        
          <li>
            <a href="/2019/11/06/rendering-on-the-web/">渲染方式简介</a>
          </li>
        
          <li>
            <a href="/2019/11/04/react-release-channels/">（概览） Preparing for the Future with React Prereleases</a>
          </li>
        
          <li>
            <a href="/2019/11/01/KV Storage/">KV Storage</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Lawrence<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//code.jquery.com/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
  <div style="display:none" id="cnzz">
  </div>
  <script>  
  var cnzz_s_tag = document.createElement('script');
  cnzz_s_tag.type = 'text/javascript';
  cnzz_s_tag.async = true;
  cnzz_s_tag.charset = 'utf-8';
  cnzz_s_tag.src = 'https://s4.cnzz.com/z_stat.php?id=1261840004&web_id=1261840004&async=1';
  var root = document.getElementById('cnzz');
  root.appendChild(cnzz_s_tag);
  </script>
</body>
</html>